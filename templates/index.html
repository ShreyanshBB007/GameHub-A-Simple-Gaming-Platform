<!DOCTYPE html>
<html>
<head>
    <title>Multi-Game Platform</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            margin: 0;
            padding: 20px;
            min-height: 100vh;
            background: #000000;  /* Dark background */
            color: #fff;
            position: relative;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(rgba(0,0,0,0.7), rgba(0,0,0,0.3)),
                        url('/static/background.png');
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            z-index: -1;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            position: relative;
            z-index: 1;
        }

        #game-selection {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 30px;
            margin: 40px 0;
        }

        .games-grid {
            display: grid;
            grid-template-columns: repeat(2, minmax(300px, 1fr));
            gap: 30px;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
        }

        .game-button {
            background: rgba(255, 165, 0, 0.9);  /* Orange with transparency */
            color: white;
            border: none;
            padding: 20px 40px;
            border-radius: 15px;
            cursor: pointer;
            font-size: 18px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            backdrop-filter: blur(5px);
            width: 100%;
            box-shadow: 0 4px 15px rgba(255, 165, 0, 0.3);
        }

        .game-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 165, 0, 0.5);
            background: rgba(255, 165, 0, 1);
        }

        .game-icon {
            width: 48px;
            height: 48px;
            background-color: rgba(255, 255, 255, 0.9);
            border-radius: 12px;
            padding: 8px;
            display: inline-block;
            background-size: 80%;
            background-repeat: no-repeat;
            background-position: center;
            margin-right: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .icon-tetris {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%23FFD700' d='M8 2h4v4H8z'/%3E%3Cpath fill='%2300BCD4' d='M12 2h4v4h-4z'/%3E%3Cpath fill='%239C27B0' d='M16 2h4v4h-4z'/%3E%3Cpath fill='%234CAF50' d='M4 6h4v4H4z'/%3E%3Cpath fill='%23F44336' d='M8 6h4v4H8z'/%3E%3C/svg%3E");
        }

        .icon-snake {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24'%3E%3Cpath fill='%234CAF50' d='M20 10c0 2-1 3-2 3s-2-1-2-3 1-3 2-3 2 1 2 3zM4 10c0 2 1 3 2 3s2-1 2-3-1-3-2-3-2 1-2 3z'/%3E%3Cpath fill='%234CAF50' d='M12 20c-4 0-8-4-8-10S8 0 12 0s8 4 8 10-4 10-8 10zm0-2c3 0 6-3 6-8s-3-8-6-8-6 3-6 8 3 8 6 8z'/%3E%3Ccircle fill='%23FF5252' cx='16' cy='7' r='1'/%3E%3C/svg%3E");
        }

        .navbar {
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid rgba(255, 165, 0, 0.3);
        }

        .user-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0 20px;
        }

        .username {
            color: #FFA500;  /* Orange */
            font-size: 18px;
            font-weight: bold;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        #logout-btn {
            background: #FF4444;
            color: white;
            padding: 12px 25px;
            border-radius: 25px;
            border: none;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        #logout-btn:hover {
            background: #FF0000;
            transform: translateY(-2px);
        }

        .leaderboard-links {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin: 40px 0;
        }

        .leaderboard-links a {
            background: rgba(255, 69, 0, 0.9);  /* Red-Orange with transparency */
            color: white;
            text-decoration: none;
            padding: 15px 30px;
            border-radius: 15px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 16px;
            box-shadow: 0 4px 15px rgba(255, 69, 0, 0.3);
        }

        .leaderboard-links a:hover {
            transform: translateY(-3px);
            background: rgba(255, 69, 0, 1);
            box-shadow: 0 8px 25px rgba(255, 69, 0, 0.5);
        }

        h1, h2 {
            color: #FFA500;  /* Orange */
            text-align: center;
            text-transform: uppercase;
            letter-spacing: 2px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        /* Game boards styling */
        .game-board {
            background: rgba(0, 0, 0, 0.8);
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            backdrop-filter: blur(10px);
            margin: 30px auto;
            max-width: 800px;
            border: 1px solid rgba(255, 165, 0, 0.3);
            display: none;
        }

        #snake-canvas, #tetris-canvas {
            border-radius: 15px;
            background-color: rgba(0, 0, 0, 0.9);
            margin: 20px auto;
            display: block;
            box-shadow: 0 4px 20px rgba(255, 165, 0, 0.2);
            border: 2px solid rgba(255, 165, 0, 0.3);
        }

        .status {
            color: #FFA500;
            text-align: center;
            margin: 15px 0;
            padding: 15px;
            font-weight: bold;
            font-size: 1.2em;
        }

        .winner {
            color: #32CD32;  /* Lime Green */
            font-size: 1.4em;
            font-weight: bold;
            animation: winnerAnimation 1s ease-in-out;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .game-controls {
            background: rgba(0, 0, 0, 0.6);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            border: 1px solid rgba(255, 165, 0, 0.2);
        }

        .control-hint {
            color: #FFA500;
            margin: 10px 0;
            font-size: 1em;
            text-align: center;
        }

        /* Updated game scores */
        #snake-score, #tetris-score {
            font-size: 28px;
            color: #FFA500;
            margin: 20px 0;
            text-align: center;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        @keyframes winnerAnimation {
            0% { transform: scale(1); }
            50% { transform: scale(1.2); }
            100% { transform: scale(1); }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="navbar">
            <div class="user-info">
                <span class="username">Welcome, {{ current_user.username }}!</span>
                <a href="{{ url_for('logout') }}" class="button" id="logout-btn">Logout</a>
            </div>
        </div>

        <h1>Multi-Game Platform</h1>
        
        <div id="game-selection">
            <h2>Select a Game:</h2>
            <div class="games-grid">
                <button onclick="joinGame('tetris')" class="game-button">
                    <span class="game-icon icon-tetris"></span>
                    Tetris
                </button>
                <button onclick="joinGame('snake')" class="game-button">
                    <span class="game-icon icon-snake"></span>
                    Snake Game
                </button>
            </div>
        </div>

        <div class="leaderboard-links">
            <a href="{{ url_for('leaderboard', game_type='tetris') }}" class="game-button">
                <span class="game-icon icon-tetris"></span>
                Tetris Leaderboard
            </a>
            <a href="{{ url_for('leaderboard', game_type='snake') }}" class="game-button">
                <span class="game-icon icon-snake"></span>
                Snake Leaderboard
            </a>
        </div>

        <div id="tetris-board" class="game-board">
            <h2>Tetris</h2>
            <div id="tetris-score">Score: 0</div>
            <canvas id="tetris-canvas" width="300" height="600"></canvas>
            <div class="game-controls">
                <p class="control-hint">Controls:</p>
                <p class="control-hint">← → : Move left/right</p>
                <p class="control-hint">↑ : Rotate</p>
                <p class="control-hint">↓ : Move down</p>
            </div>
            <div id="tetris-status" class="status"></div>
            <button onclick="resetGame('tetris')" id="tetris-reset" style="display: none;">Play Again</button>
        </div>

        <div id="snake-board" class="game-board">
            <h2>Snake Game</h2>
            <div id="snake-score">Score: 0</div>
            <canvas id="snake-canvas" width="400" height="400"></canvas>
            <div id="snake-controls">
                <p>Use arrow keys to control the snake</p>
                <button onclick="resetGame('snake')" id="snake-reset" style="display: none;">Play Again</button>
            </div>
            <div id="snake-status" class="status"></div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        const socket = io();
        let currentGame = '';
        let currentRoom = '';
        let gameEnded = false;
        let gameLoop;

        // Snake game variables
        const snakeCanvas = document.getElementById('snake-canvas');
        const snakeCtx = snakeCanvas.getContext('2d');
        const gridSize = 20;
        const snakeTileSize = snakeCanvas.width / gridSize;

        // Tetris game variables
        const tetrisCanvas = document.getElementById('tetris-canvas');
        const tetrisCtx = tetrisCanvas.getContext('2d');
        const blockSize = 30;

        function drawTetrisBoard(board, currentPiece, piecePosition) {
            tetrisCtx.fillStyle = '#1c1c1c';
            tetrisCtx.fillRect(0, 0, tetrisCanvas.width, tetrisCanvas.height);

            // Draw the fixed blocks
            for(let row = 0; row < board.length; row++) {
                for(let col = 0; col < board[row].length; col++) {
                    if(board[row][col]) {
                        tetrisCtx.fillStyle = '#4CAF50';
                        tetrisCtx.fillRect(col * blockSize, row * blockSize, blockSize - 1, blockSize - 1);
                    }
                }
            }

            // Draw the current piece
            if(currentPiece && piecePosition) {
                tetrisCtx.fillStyle = '#2196F3';
                for(let row = 0; row < currentPiece.length; row++) {
                    for(let col = 0; col < currentPiece[row].length; col++) {
                        if(currentPiece[row][col]) {
                            tetrisCtx.fillRect(
                                (piecePosition[1] + col) * blockSize,
                                (piecePosition[0] + row) * blockSize,
                                blockSize - 1,
                                blockSize - 1
                            );
                        }
                    }
                }
            }
        }

        function joinGame(game) {
            currentGame = game;
            currentRoom = game + '-' + Math.random().toString(36).substr(2, 9);
            gameEnded = false;
            
            document.querySelectorAll('.game-board').forEach(board => board.style.display = 'none');
            document.getElementById(game + '-board').style.display = 'block';
            
            if (game === 'tetris') {
                document.getElementById('tetris-status').textContent = '';
                document.getElementById('tetris-reset').style.display = 'none';
                document.getElementById('tetris-score').textContent = 'Score: 0';
                socket.emit('join_tetris', { room: currentRoom });
                
                // Start game loop for automatic piece descent
                if (gameLoop) clearInterval(gameLoop);
                gameLoop = setInterval(() => {
                    if (!gameEnded) {
                        socket.emit('tetris_move', { 
                            room: currentRoom,
                            move: 'down'
                        });
                    }
                }, 1000);
            } else if (game === 'snake') {
                document.getElementById('snake-status').textContent = '';
                document.getElementById('snake-reset').style.display = 'none';
                document.getElementById('snake-score').textContent = 'Score: 0';
                clearCanvas(snakeCtx, snakeCanvas);
                socket.emit('join_snake', { room: currentRoom });
                
                if (gameLoop) clearInterval(gameLoop);
                gameLoop = setInterval(() => {
                    if (!gameEnded) {
                        socket.emit('snake_move', { room: currentRoom });
                    }
                }, 100);
            }
        }

        // Handle keyboard controls
        document.addEventListener('keydown', (event) => {
            if (!gameEnded) {
                if (currentGame === 'snake') {
                    const key = event.key;
                    let direction = '';
                    
                    if (key === 'ArrowUp') direction = 'UP';
                    else if (key === 'ArrowDown') direction = 'DOWN';
                    else if (key === 'ArrowLeft') direction = 'LEFT';
                    else if (key === 'ArrowRight') direction = 'RIGHT';
                    
                    if (direction) {
                        socket.emit('snake_direction', {
                            room: currentRoom,
                            direction: direction
                        });
                    }
                } else if (currentGame === 'tetris') {
                    const key = event.key;
                    let move = '';
                    
                    if (key === 'ArrowLeft') move = 'left';
                    else if (key === 'ArrowRight') move = 'right';
                    else if (key === 'ArrowDown') move = 'down';
                    else if (key === 'ArrowUp') move = 'rotate';
                    
                    if (move) {
                        socket.emit('tetris_move', {
                            room: currentRoom,
                            move: move
                        });
                    }
                }
            }
        });

        function resetGame(game) {
            joinGame(game);
        }

        socket.on('game_joined', (data) => {
            if (data.game === 'tetris') {
                drawTetrisBoard(data.gameState.board, data.gameState.current_piece, data.gameState.piece_position);
            } else if (data.game === 'snake') {
                updateSnakeGame(data.gameState);
            }
        });

        socket.on('game_error', (data) => {
            document.getElementById('tictactoe-status').textContent = data.message;
        });

        socket.on('game_update', (gameState) => {
            if (currentGame === 'tetris') {
                drawTetrisBoard(gameState.board, gameState.current_piece, gameState.piece_position);
                document.getElementById('tetris-score').textContent = `Score: ${gameState.score}`;
                
                if (gameState.game_over) {
                    gameEnded = true;
                    document.getElementById('tetris-status').innerHTML = 
                        `<span class="winner">Game Over! Final Score: ${gameState.score}</span>`;
                    document.getElementById('tetris-reset').style.display = 'block';
                    clearInterval(gameLoop);
                    socket.emit('update_score', {
                        game_type: 'tetris',
                        score: gameState.score
                    });
                }
            } else if (currentGame === 'snake') {
                updateSnakeGame(gameState);
            }
        });

        function updateSnakeGame(gameState) {
            clearCanvas(snakeCtx, snakeCanvas);
            drawSnake(gameState.snake);
            drawFood(gameState.food);
            document.getElementById('snake-score').textContent = `Score: ${gameState.score}`;
            
            if (gameState.game_over) {
                gameEnded = true;
                document.getElementById('snake-status').innerHTML = 
                    `<span class="winner">Game Over! Final Score: ${gameState.score}</span>`;
                document.getElementById('snake-reset').style.display = 'block';
                clearInterval(gameLoop);
                socket.emit('update_score', {
                    game_type: 'snake',
                    score: gameState.score
                });
            }
        }

        function drawSnake(snake) {
            snakeCtx.fillStyle = '#4CAF50';
            snake.forEach(([x, y], index) => {
                if (index === 0) {
                    snakeCtx.fillStyle = '#2E7D32';  // Darker green for head
                } else {
                    snakeCtx.fillStyle = '#4CAF50';
                }
                snakeCtx.fillRect(x * snakeTileSize, y * snakeTileSize, snakeTileSize - 1, snakeTileSize - 1);
            });
        }

        function drawFood(food) {
            snakeCtx.fillStyle = '#FF5252';
            snakeCtx.beginPath();
            snakeCtx.arc(
                (food.x * snakeTileSize) + snakeTileSize/2,
                (food.y * snakeTileSize) + snakeTileSize/2,
                snakeTileSize/2 - 1,
                0,
                Math.PI * 2
            );
            snakeCtx.fill();
        }

        function clearCanvas(ctx, canvas) {
            ctx.fillStyle = '#1c1c1c';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
        }
    </script>
</body>
</html>